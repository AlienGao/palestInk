---
title: qiankunå¾®å‰ç«¯åº”ç”¨
date: 2021-08-11 21:41:00
permalink: /pages/ee319a/
categories:
  - æŠ€æœ¯
tags:
  - qiankun
---
æ ¹æ®å…¬å¸é¡¹ç›®éœ€è¦ï¼Œå°†è€é¡¹ç›®çš„è§†é¢‘ç›‘æ§åŠŸèƒ½ç§»æ¤åˆ°æ–°é¡¹ç›®ä¸­ï¼Œæ­£å¥½æœ‰æœºä¼šå®è·µä¸€ä¸‹qiankunæ¡†æ¶ã€‚æ ¹æ®[å®˜ç½‘][1]ä»‹ç»ï¼Œåº”ç”¨qiankunå¯¹æŠ€æœ¯æ ˆæ²¡æœ‰é™åˆ¶ï¼Œç”±äºqiankunçš„Apiéå¸¸ç®€æ´ï¼Œä¸»åº”ç”¨ä¸å­åº”ç”¨è¿›è¡Œç®€å•é…ç½®ï¼Œå°±èƒ½å®Œæˆæ”¹é€ ã€‚æœ€ååˆ†äº«ä¸€ä¸ªæ ¹æ®å®˜ç½‘æ­å»ºçš„qiankunå¾®åº”ç”¨ï¼Œå®ç°çˆ¶åº”ç”¨ä¸å­åº”ç”¨çš„ï¿½é€šä¿¡ï¼Œè‹¥æ˜¯qiankunå¯åŠ¨ï¼Œå…„å¼Ÿåº”ç”¨å¯ä»¥é€šè¿‡ä¿®æ”¹çˆ¶åº”ç”¨çš„å…¨å±€çŠ¶æ€æ¥é€šä¿¡ã€‚

é¡¹ç›®åœ°å€ï¼š[https://github.com/AlienGao/qiankun-demo][2]

ä¸»åº”ç”¨é…ç½®
------

*main/src/micro-apps.js*

    import shared from './shared'
    
    const mircoApps = [
      {
        name: 'react-app',
        entry: process.env.REACT_APP_REACT_PATH,
        activeRule: '/app-react',
      },
      {
        name: 'vue-app',
        entry: process.env.REACT_APP_VUE_PATH,
        activeRule: '/app-vue',
      }
    ]
    
    // console.log(process.env, 'vue_path')
    
    const apps = mircoApps.map(app => {
      return {
        ...app,
        // å­åº”ç”¨å®¹å™¨
        container: '#container',
        props: {
          // æš´éœ²ç»™å­åº”ç”¨çš„æ–¹æ³•
          getGlobalState: shared.getGlobalState,
          setGlobalState: shared.setGlobalState
        }
      }
    })
    
    export default apps
    
*main/src/shared/index.js*
    
    import { initGlobalState } from 'qiankun';
    
    const initialState = { taskList: [] };
    
    const actions = initGlobalState(initialState);
    
    actions.onGlobalStateChange((newState, prev) => {
      // state: å˜æ›´åçš„çŠ¶æ€; prev å˜æ›´å‰çš„çŠ¶æ€
      console.log('main change', JSON.stringify(newState), JSON.stringify(prev));
    
      for (let key in newState) {
        initialState[key] = newState[key]
      }
    }, true);
    
    // å®šä¹‰ä¸€ä¸ªè·å–stateçš„æ–¹æ³•ä¸‹å‘åˆ°å­åº”ç”¨
    actions.getGlobalState = (key) => {
      // æœ‰keyï¼Œè¡¨ç¤ºå–globalStateä¸‹çš„æŸä¸ªå­çº§å¯¹è±¡
      // æ— keyï¼Œè¡¨ç¤ºå–å…¨éƒ¨
      return key ? initialState[key] : initialState
    }
    
    // actions.setGlobalState(state);
    
    export default actions;
    
è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸»è¦é…ç½®äº†å­åº”ç”¨çš„ç«¯å£ï¼Œå®¹å™¨å’Œéœ€è¦ç”¨åˆ°çš„æ–¹æ³•ï¼Œé€šè¿‡å°†setGloablStateæš´éœ²ç»™å­åº”ç”¨ï¼Œå¯ä»¥åšåˆ°é€šè¿‡ä¸€ä¸ªå­åº”ç”¨ä¿®æ”¹å…¨å±€çŠ¶æ€å†åŒæ­¥ç»™å¦ä¸€ä¸ªå­åº”ç”¨ã€‚

æœ€åï¼Œåœ¨çˆ¶åº”ç”¨çš„å…¥å£æ–‡ä»¶æ³¨å†Œå­åº”ç”¨ã€‚

    import reportWebVitals from './reportWebVitals';
    import { registerMicroApps, start, setDefaultMountApp } from 'qiankun';
    import microApps from './micro-apps'
    
    const apps = microApps
    
    ReactDOM.render(
      <React.StrictMode>
        <App />
      </React.StrictMode>,
      document.getElementById('root')
    );
    
    registerMicroApps(apps, {
      beforeLoad: [app => {
        console.log(`${app.name}-beforeLoad`)
      }],
      beforeMount: [app => {
        console.log(`${app.name}-beforeMount`)
      }],
      afterMount: [app => {
        console.log(`${app.name}-afterMount`)
      }],
      beforeUnmount: [app => {
        console.log(`${app.name}-beforeUnmount`)
      }],
      afterUnmount: [app => {
        console.log(`${app.name}-beforeUnmount`)
      }]
    });
    
    setDefaultMountApp('/app-vue')
    // å¯åŠ¨ qiankun
    start();
![æ•ˆæœå›¾][3]
ä¸Šé¢ä¸ºæ•ˆæœå›¾ï¼Œä¸Šæ–¹ä¸ºä¸»åº”ç”¨ï¼Œä¸‹æ–¹ä½å¾®åº”ç”¨å®¹å™¨ã€‚

å­åº”ç”¨é…ç½®
-----
å­åº”ç”¨é¦–å…ˆéœ€è¦åœ¨å…¥å£æ–‡ä»¶å¤„é…ç½®ä¸‰ä¸ªé’©å­å‡½æ•°ç”¨äºqiankunè¯†åˆ«ç”Ÿå‘½å‘¨æœŸã€‚

*vue-app/src/main.js*

    export async function bootstrap() {
      console.log('[vue] vue app bootstraped');
    }
    export async function mount(props) {
      console.log('[vue] props from main framework', props);
      globalRegister(store, props)
      render(props);
    }
    export async function unmount() {
      instance.$destroy();
      instance.$el.innerHTML = '';
      instance = null;
      router = null;
    }
    
å…¶æ¬¡åœ¨Vueå­åº”ç”¨mountæ—¶æœŸï¼Œé€šè¿‡globalRegisterå‡½æ•°åˆå§‹åŒ–äº†å…¨å±€çŠ¶æ€ã€‚

*vue-app/src/shared/index.js*

    /**
     * 
     * @param {vuexå®ä¾‹} store 
     * @param {qiankunä¸‹å‘çš„props} props 
     */
    function registerGlobalModule(store, props = {}) {
      if (!store || !store.hasModule) {
        return;
      }
    
      // è·å–åˆå§‹åŒ–çš„state
      const initState = props.getGlobalState && props.getGlobalState() || {};
      // å°†çˆ¶åº”ç”¨çš„æ•°æ®å­˜å‚¨åˆ°å­åº”ç”¨ä¸­ï¼Œå‘½åç©ºé—´å›ºå®šä¸ºglobal
      if (!store.hasModule('global')) {
        const globalModule = {
          namespaced: true,
          state: initState,
          actions: {
            // å­åº”ç”¨æ”¹å˜stateå¹¶é€šçŸ¥çˆ¶åº”ç”¨
            setGlobalState({ commit }, payload) {
              commit('setGlobalState', payload);
              commit('emitGlobalState', payload);
            },
            // åˆå§‹åŒ–ï¼Œåªç”¨äºmountæ—¶åŒæ­¥çˆ¶åº”ç”¨çš„æ•°æ®
            initGlobalState({ commit }, payload) {
              commit('setGlobalState', payload);
            },
          },
          mutations: {
            setGlobalState(state, payload) {
              // eslint-disable-next-line
              state = Object.assign(state, payload);
            },
            // é€šçŸ¥çˆ¶åº”ç”¨
            emitGlobalState(state) {
              if (props.setGlobalState) {
                // console.log(state, 'emitGlobalState')
                props.setGlobalState(state);
              }
            },
          },
        };
        store.registerModule('global', globalModule);
      } else {
        // æ¯æ¬¡mountæ—¶ï¼Œéƒ½åŒæ­¥ä¸€æ¬¡çˆ¶åº”ç”¨æ•°æ®
        store.dispatch('global/initGlobalState', initState);
      }
    }
    
    export default registerGlobalModule;

è‹¥Vueåº”ç”¨æ²¡æœ‰global Modalï¼Œåˆ™æ ¹æ®å…¨å±€çŠ¶æ€åˆ›å»ºä¸€ä¸ªã€‚å…¶ä¸­èƒ½å¤Ÿé€šè¿‡çˆ¶åº”ç”¨ä¼ é€’çš„setGlobalStateæ–¹æ³•æ”¹å˜çˆ¶åº”ç”¨çŠ¶æ€ã€‚

      computed: {
        taskList() {
          return this.$store.state.global.taskList;
        }
      },
    methods: {
        onChange(task) {
          this.$store.dispatch('global/setGlobalState', task)
          // this.microSetGlobalState(this.$store.state.global)
            }
      },
Vueåº”ç”¨å¯ä»¥é€šè¿‡è®¡ç®—å±æ€§è·å–æœ€æ–°çš„çˆ¶åº”ç”¨çŠ¶æ€ã€‚å…¶ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¿®æ”¹çˆ¶åº”ç”¨çŠ¶æ€ï¼Œä¸€ç§æ˜¯é€šè¿‡dispatch 'global/setGlobalState' actionï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥é€šè¿‡çˆ¶åº”ç”¨ä¼ é€’çš„setGlobalStateæ–¹æ³•ä¿®æ”¹ï¼Œè¯¥æ–¹æ³•éœ€è¦åœ¨Vueçš„å…¥å£æ–‡ä»¶ä¸­è®¾ç½®Vueå®ä¾‹çš„å…¨å±€æ–¹æ³•ã€‚

*vue-app/src/main.js*

      const { container, getGlobalState } = props;
      Vue.prototype.getGlobalState = getGlobalState

ç‚¹å‡»çˆ¶åº”ç”¨æ·»åŠ ä»»åŠ¡ï¼Œåœ¨Vueåº”ç”¨ä¸­è¿›è¡ŒåŒå‘ç»‘å®šã€‚
![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°][4]

åœ¨Vueå­åº”ç”¨ä¸­ä¿®æ”¹ä»»åŠ¡
![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°][5]

èƒ½å¤Ÿåœ¨å…„å¼Ÿåº”ç”¨ä¸­å±•ç¤ºæœ€æ–°çš„ä»»åŠ¡å†…å®¹
![æ­¤å¤„è¾“å…¥å›¾ç‰‡çš„æè¿°][6]

æœ€åæœªæ¥è®©ä¸»åº”ç”¨èƒ½æ­£ç¡®è¯†åˆ«å¾®åº”ç”¨æš´éœ²å‡ºæ¥çš„ä¸€äº›ä¿¡æ¯ï¼Œå¾®åº”ç”¨çš„æ‰“åŒ…å·¥å…·éœ€è¦å¢åŠ å¦‚ä¸‹é…ç½®ã€‚

*vue-app/vue.config.js*

    const { name } = require('./package');
    module.exports = {
      devServer: {
        // open: true,
        // hot: true,
        // compress: true,
        // disableHostCheck: true,
        headers: {
          'Access-Control-Allow-Origin': '*',
        },
      },
      configureWebpack: {
        output: {
          library: `${name}-[name]`,
          libraryTarget: 'umd', // æŠŠå¾®åº”ç”¨æ‰“åŒ…æˆ umd åº“æ ¼å¼
          jsonpFunction: `webpackJsonp_${name}`,
        },
      },
    };

ğŸ‰å½©è›‹ğŸ‰ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­é…ç½®äº†npm-run-allçš„å‘½ä»¤ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ä¸»åº”ç”¨ä¸å­åº”ç”¨ã€‚

  [1]: https://qiankun.umijs.org/zh
  [2]: https://github.com/AlienGao/qiankun-demo
  [3]: https://cdn.jsdelivr.net/gh/AlienGao/image-store@main/blog/image.1b6hntpvy0m.png
  [4]: https://cdn.jsdelivr.net/gh/AlienGao/image-store@main/blog/image.6113sfc4p34.png
  [5]: https://cdn.jsdelivr.net/gh/AlienGao/image-store@main/blog/image.1jh5t7uspl40.png
  [6]: https://cdn.jsdelivr.net/gh/AlienGao/image-store@main/blog/image.1aablsy30qrk.png